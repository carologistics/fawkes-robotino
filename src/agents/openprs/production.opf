;---------------------------------------------------------------------------
;  production.opf - OpenPRS OP file for RCll2017 openprs-agent
;
;  Created: Tue Jan 17 15:43:00 2017
;  Copyright  2017  Mostafa Gomaa [gomaa@kbsg.rwth-aachen.de]
;  Licensed under GPLv2+ license, cf. LICENSE file
;---------------------------------------------------------------------------

(

	(defop produce-c0-imperative
		:invocation	(timer "beacon" $last-sec $last-usec $seq)
		:context(	(order $id c0 $base-color $ring-colors $cap-color $quantity-requested $quantity-delivered $delivery-period-begin $delivery-period-end $delivery-gate)
				 	(cap-station $cs-name $cap-color)
				 	(machine $bs-name "BS" $bs-state $bs-prepared $bs-zone $bs-pose $bs-loaded-with)
				 	(machine $cs-name "CS" $cs-state $cs-prepared $cs-zone $cs-pose $cs-loaded-with)
					(peer-id private $peer-id)
				   	(team-color $team-color )
				   	(agent-state IDLE)
				   	)

		:body(
			(~> (agent-state IDLE))
			(! (print "Producing C0..."))


			(! (print "PRELOADING CAP STATION..."))
			(! (= $slot "LEFT")) 								;dynamically dertiermine which position. 
 			(! (get-product-from place $cs-name shelf $slot))

			(! (= @cs-inst (pb-create "llsf_msgs.PrepareInstructionCS")))
			(! (pb-set-field @cs-inst "operation" RETRIEVE_CAP))
			(! (= @instruction (pb-create "llsf_msgs.PrepareMachine")))
			(! (pb-set-field @instruction "instruction_cs" @cs-inst ))
			(! (pb-set-field @instruction "team_color" $team-color))
			(! (pb-set-field @instruction "machine" $cs-name ))
			(! (pb-broadcast $peer-id @instruction))

			(! (bring-product-to place $cs-name atmps $slot))

			(! (drive-to (string-cat $cs-name "-O")))
			(! (get-product-from place $cs-name side "output"))


			(! (print "FETHCHING THE BASE..."))
			(! (print (string-cat $bs-name "-I")))
			(! (drive-to (string-cat $bs-name "-I"))) ;; todos, get the side from a fact that makes sure the active-side is updated
			; todo:get the lock
			(! (= @bs-inst (pb-create "llsf_msgs.PrepareInstructionBS")))
			(! (pb-set-field @bs-inst "side" INPUT))
			(! (pb-set-field @bs-inst "color" $base-color))
			(! (= @instruction (pb-create "llsf_msgs.PrepareMachine")))
			(! (pb-set-field @instruction "instruction_bs" @bs-inst ))
			(! (pb-set-field @instruction "team_color" $team-color))
			(! (pb-set-field @instruction "machine" $bs-name ))
			(! (pb-broadcast $peer-id @instruction))

			(! (get-product-from place $bs-name side "input"))
			
			(! (print "INSETRING INTO CS..."))
			(! (drive-to (string-cat $cs-name "-I"))) 

			(! (= @cs-inst (pb-create "llsf_msgs.PrepareInstructionCS")))
			(! (pb-set-field @cs-inst "operation" MOUNT_CAP))
			(! (= @instruction (pb-create "llsf_msgs.PrepareMachine")))
			(! (pb-set-field @instruction "instruction_cs" @cs-inst ))
			(! (pb-set-field @instruction "team_color" $team-color))
			(! (pb-set-field @instruction "machine" $cs-name ))
			(! (pb-broadcast $peer-id @instruction))

			(! (bring-product-to place $cs-name))


			)


	:effects ()
	:documentation "A completly imparative way to produce the c0 product using only a single robot. 
					This is only an exemplary Op to test the water. It starts in response for a C0 order and assumes nothing else is happing on the feild
					No locks. No coordination and everything is hard coded"

	)














	)